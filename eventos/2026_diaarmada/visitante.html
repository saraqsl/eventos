<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ver QSL â€“ EV07-25</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #eef2f5;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
  padding: 20px;
}
h1 { color: #333; }
input, button {
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
  border: 1px solid #ccc;
  width: 80%;
}
button {
  cursor: pointer;
  background: #007bff;
  color: white;
  border: none;
}
button:hover { background: #0056b3; }
canvas { margin-top: 20px; border: 1px solid #ccc; }
</style>
</head>
<body>

<h1>ðŸ”Ž Ver QSL â€“ EV07-25</h1>

<input type="text" id="sdVisitante" placeholder="Ingrese su SD (ej: LU1ABC)">
<button onclick="verQSL()">Ver mis QSLs</button>
<button onclick="descargarTodas()" id="btnDescargarTodas" style="display:none;">Descargar todas</button>

<div id="qslContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>

<script>
const ACCESS_TOKEN = "579631306771-oqelv0m55ronmkgqem6a85ko5jt0afkb.apps.googleusercontent.com"; // tu token vÃ¡lido
const FOLDER_ID = "1YJdk8Ymc77F5Nbgd8uWldlxgqNppkLys"; // carpeta de Drive con JSON de activadores
const IMG_QSL = "QSL.jpg"; // imagen de fondo
let canvasesGenerados = [];

// Listar ADIFs en Drive
async function listarADIFs() {
  const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents&fields=files(id,name)&access_token=${ACCESS_TOKEN}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.files || [];
}

// Leer archivo JSON desde Drive
async function leerADIF(fileId) {
  const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&access_token=${ACCESS_TOKEN}`;
  const res = await fetch(url);
  return res.json();
}

// Generar QSL en canvas
function generarQSL(activador, contacto) {
  const canvas = document.createElement('canvas');
  canvas.width = 600;
  canvas.height = 400;
  const ctx = canvas.getContext('2d');

  const img = new Image();
  img.src = IMG_QSL;
  img.onload = () => {
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    // SD del activador en grande
    ctx.font = 'bold 40px Arial';
    ctx.fillStyle = 'red';
    ctx.textAlign = 'center';
    ctx.fillText(activador, canvas.width / 2, 80);

    // Datos del contacto
    ctx.font = '20px Arial';
    ctx.fillStyle = 'black';
    ctx.textAlign = 'left';
    const yBase = 150;
    const lineHeight = 30;
    const datos = [
      `SD Visitante: ${contacto.call}`,
      `Fecha: ${contacto.date}`,
      `Hora: ${contacto.time}`,
      `Banda: ${contacto.band}`,
      `Modo: ${contacto.mode}`
    ];
    datos.forEach((d, i) => ctx.fillText(d, 50, yBase + i*lineHeight));

    document.getElementById('qslContainer').appendChild(canvas);
    canvasesGenerados.push({canvas, activador, visitante: contacto.call});
  };
}

// Ver QSLs del visitante
async function verQSL() {
  const sdVisitante = document.getElementById('sdVisitante').value.trim().toUpperCase();
  if (!sdVisitante) return alert("Ingrese su SD");

  const container = document.getElementById('qslContainer');
  container.innerHTML = "Cargando...";
  canvasesGenerados = [];
  document.getElementById('btnDescargarTodas').style.display = 'none';

  try {
    const files = await listarADIFs();
    container.innerHTML = '';

    for (let file of files) {
      const adifData = await leerADIF(file.id);
      adifData.forEach(contacto => {
        if (contacto.call === sdVisitante) {
          generarQSL(contacto.owner, contacto);
        }
      });
    }

    if (canvasesGenerados.length > 0) {
      document.getElementById('btnDescargarTodas').style.display = 'inline-block';
    } else {
      container.textContent = "No se encontraron QSLs para este SD.";
    }

  } catch (err) {
    console.error(err);
    container.textContent = "Error al cargar QSLs desde Drive.";
  }
}

// Descargar todas las QSLs como ZIP
async function descargarTodas() {
  if (!canvasesGenerados.length) return;
  const zip = new JSZip();
  canvasesGenerados.forEach((c, idx) => {
    const dataUrl = c.canvas.toDataURL('image/png');
    const base64 = dataUrl.split(',')[1];
    zip.file(`${c.activador}_${c.visitante}.png`, base64, {base64:true});
  });
  const content = await zip.generateAsync({type:"blob"});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(content);
  link.download = 'mis_qsls.zip';
  link.click();
}
</script>

</body>
</html>
