<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwGheoFenZr8EfbrZ3H2SNwHX0lgKe45xF_3WIQ-0FL1Q5qc03H_2onSTlD76RHmFxMUA/exec";
const IMG_QSL = "qsl.jpg"; 
let canvasesGenerados = [];

// 🧩 Generar QSL en canvas (dos líneas de datos, negrita)
function generarQSL(activador, contacto) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    canvas.width = 600;
    canvas.height = 400;
    const ctx = canvas.getContext('2d');

    const img = new Image();
    img.src = IMG_QSL;
    img.onload = () => {
      // Fondo
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      // Activador a la izquierda
      ctx.font = 'bold 36px Arial';
      ctx.fillStyle = 'red';
      ctx.textAlign = 'left';
      ctx.fillText(activador, 20, 70);

      // Datos abajo en dos líneas centradas
      ctx.font = 'bold 20px Arial';
      ctx.fillStyle = 'black';
      ctx.textAlign = 'center';
      const linea1 = `QSO con ${contacto.call}  Fecha: ${contacto.date}`;
      const linea2 = `Hora UTC: ${contacto.time}  Banda: ${contacto.band}  Modo: ${contacto.mode}`;
      ctx.fillText(linea1, canvas.width / 2, canvas.height - 60);
      ctx.fillText(linea2, canvas.width / 2, canvas.height - 30);

      document.getElementById('qslContainer').appendChild(canvas);
      canvasesGenerados.push({canvas, activador, visitante: contacto.call});
      resolve();
    };
  });
}

// 🧩 Ver QSLs del visitante
async function verQSL() {
  const sdVisitante = document.getElementById('sdVisitante').value.trim().toUpperCase();
  if (!sdVisitante) return alert("Ingrese su SD");

  const container = document.getElementById('qslContainer');
  container.innerHTML = "Cargando...";
  canvasesGenerados = [];
  document.getElementById('accionesDescarga').style.display = 'none';

  try {
    const res = await fetch(API_URL);
    const allData = await res.json();

    container.innerHTML = "";
    let encontrados = 0;

    for (const contacto of allData) {
      if (contacto.call === sdVisitante) {
        await generarQSL(contacto.owner, contacto);
        encontrados++;
      }
    }

    if (encontrados === 0) {
      container.textContent = "No se encontraron QSLs para este SD.";
    } else {
      document.getElementById('accionesDescarga').style.display = 'flex';
    }

  } catch (err) {
    console.error(err);
    container.textContent = "❌ Error al cargar datos del evento.";
  }
}

// 📦 Descargar todas las QSLs como ZIP
async function descargarTodas() {
  if (!canvasesGenerados.length) return;
  const zip = new JSZip();
  canvasesGenerados.forEach((c) => {
    const dataUrl = c.canvas.toDataURL('image/jpeg', 0.92);
    const base64 = dataUrl.split(',')[1];
    zip.file(`${c.activador}_${c.visitante}.jpg`, base64, {base64:true});
  });
  const content = await zip.generateAsync({type:"blob"});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(content);
  link.download = 'mis_qsls.zip';
  link.click();
}

// 🖼️ Descargar imagen actual (JPG o PNG)
function descargarActual(formato = 'jpg') {
  if (!canvasesGenerados.length) return alert('No hay QSL generada.');
  const canvas = canvasesGenerados[0].canvas;
  const tipo = formato === 'png' ? 'image/png' : 'image/jpeg';
  const nombre = `mi_qsl.${formato}`;
  const link = document.createElement('a');
  link.download = nombre;
  link.href = canvas.toDataURL(tipo, 0.92);
  link.click();
}

// 📋 Copiar imagen al portapapeles
async function copiarActual() {
  if (!canvasesGenerados.length) return alert('No hay QSL generada.');
  const canvas = canvasesGenerados[0].canvas;
  const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
  await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
  alert('📋 Imagen copiada al portapapeles');
}
</script>
