<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cargar ADIF ‚Äì Panel Activador</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #eef2f5;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
  padding: 0;
}
h1 { margin-top: 20px; color: #333; }
.card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  margin: 15px;
  padding: 15px;
  width: 90%;
  max-width: 500px;
}
#claveAcceso { border-left: 5px solid #007bff; }
#panelActivador { border-left: 5px solid #28a745; display: none; }
input, button {
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
  border: 1px solid #ccc;
  width: 80%;
}
button {
  cursor: pointer;
  background: #007bff;
  color: white;
  border: none;
}
button:hover { background: #0056b3; }
p#infoAdmin {
  background: #e8f5e9;
  padding: 10px;
  border-radius: 6px;
  color: #1b5e20;
  display: none;
}
a.volver {
  display: inline-block;
  margin-top: 20px;
  text-decoration: none;
  color: #007bff;
  font-weight: bold;
}
a.volver:hover { text-decoration: underline; }
</style>
</head>
<body>

<h1>üîë Panel Activador ‚Äì EV07-25</h1>

<!-- CLAVE DE ACCESO -->
<div id="claveAcceso" class="card">
  <h2>Ingreso seguro</h2>
  <p>Ingres√° la clave de activador:</p>
  <input type="password" id="clave" placeholder="Clave de acceso">
  <button onclick="verificarClave()">Ingresar</button>
</div>

<!-- PANEL DE CARGA -->
<div id="panelActivador" class="card">
  <h2>Cargar archivos ADIF</h2>
  <input type="text" id="indicativoActivador" placeholder="Indicativo (ej: LU1XYZ)">
  <input type="file" id="archivoAdif" accept=".adi,.adif" multiple>
  <button onclick="cargarADIF()">Generar JSON</button>
  <p id="infoAdmin"></p>
</div>

<a href="index.html" class="volver">‚¨Ö Volver al inicio</a>

<script>
const CLAVE_CORRECTA = "sara";
const ACCESS_TOKEN = "TU_ACCESS_TOKEN_AQUI"; // reemplazar por token OAuth v√°lido
const FOLDER_ID = "ID_CARPETA_DRIVE_AQUI";   // reemplazar por ID de carpeta en Drive

// Verificaci√≥n de clave
function verificarClave() {
  const clave = document.getElementById('clave').value.trim();
  if (clave === CLAVE_CORRECTA) {
    document.getElementById('panelActivador').style.display = 'block';
    document.getElementById('claveAcceso').style.display = 'none';
  } else {
    alert("‚ùå Clave incorrecta");
  }
}

// Parsear ADIF y generar array de contactos
function parseADIF(texto, activador) {
  const qsos = texto.split(/<eor>/i).filter(x => x.trim().length);
  return qsos.map(qso => {
    const get = tag => {
      const regex = new RegExp(`<${tag}:\\d+>(.*?)<`, 'i');
      const m = qso.match(regex);
      return m ? m[1].trim() : '';
    };
    return {
      owner: activador,
      call: get('CALL')?.toUpperCase(),
      date: get('QSO_DATE'),
      time: get('TIME_ON'),
      band: get('BAND'),
      mode: get('MODE')
    };
  }).filter(x => x.call);
}

// Cargar ADIF y generar JSON
async function cargarADIF() {
  const activador = document.getElementById('indicativoActivador').value.trim().toUpperCase();
  if (!activador) return alert("Ingrese su indicativo de activador");

  const files = document.getElementById('archivoAdif').files;
  if (!files.length) return alert("Seleccione uno o m√°s archivos ADIF");

  let todos = [];

  try {
    // Leer todos los archivos
    for (let file of files) {
      const texto = await file.text();
      const contactos = parseADIF(texto, activador);
      todos.push(...contactos);
    }

    // Crear blob JSON
    const jsonContent = JSON.stringify(todos, null, 2);
    const blob = new Blob([jsonContent], { type: 'application/json' });

    // Nombre con indicativo y fecha
    const hoy = new Date();
    const fechaStr = hoy.toISOString().slice(0,10).replace(/-/g,'');
    const fileName = `${activador}_${fechaStr}_evento.json`;

    // Preparar metadata para Drive
    const metadata = {
      name: fileName,
      parents: [FOLDER_ID],
      mimeType: 'application/json'
    };

    const formData = new FormData();
    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    formData.append('file', blob);

    // Subida a Drive (comentada si no hay token v√°lido)
    /*
    const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + ACCESS_TOKEN },
      body: formData
    });
    const data = await res.json();
    */

    // Mostrar mensaje de confirmaci√≥n
    const info = document.getElementById('infoAdmin');
    info.style.display = 'block';
    info.textContent = `‚úÖ JSON generado: ${fileName} (subida a Drive lista, requiere token v√°lido)`;

  } catch(err) {
    console.error(err);
    alert("Error al procesar los archivos ADIF");
  }
}
</script>
</body>
</html>

