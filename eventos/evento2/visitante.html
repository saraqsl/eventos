<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ver QSL â€“ EV07-25</title>
<style>
body {
  font-family: "Courier New", monospace;
  background: #e5ebf0;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
  padding: 20px;
}
h1 {
  color: #002b5c;
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 1px;
}
input, button {
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
  border: 1px solid #ccc;
  width: 80%;
  max-width: 300px;
  font-family: "Courier New", monospace;
}
button {
  cursor: pointer;
  background: #003366;
  color: white;
  border: none;
  text-transform: uppercase;
  transition: 0.2s;
}
button:hover { background: #0056b3; }
canvas { 
  margin-top: 10px; 
  border: 2px solid #003366; 
  display: block;
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  width: 100%;
  max-width: 530px;
  height: auto;
}
.qslCard {
  margin-bottom: 20px;
  text-align: center;
}
.qslCard button {
  margin-top: 8px;
  background: #004c99;
  font-size: 0.9em;
  padding: 6px 10px;
}
.qslCard button:hover {
  background: #0070cc;
}
#accionesDescarga {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
  margin-top: 10px;
}
</style>
</head>
<body>

<h1>ğŸ” Ver QSL con la estaciÃ³n LU7WH</h1>

<input type="text" id="sdVisitante" placeholder="Ingrese su SD (ej: LU1ABC)">
<button onclick="verQSL()">Ver mis QSLs</button>

<div id="accionesDescarga" style="display:none;">
  <button onclick="descargarTodas()">ğŸ“¦ Descargar ZIP</button>
  <button onclick="descargarActual()">ğŸ–¼ï¸ Descargar imagen</button>
  <button onclick="copiarActual()">ğŸ“‹ Copiar imagen</button>
</div>

<div id="qslContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbysRnXsh6QUwgGlIPltyj8EnoeQTtoNnx3fe1Mf5hwQcWQp3m5P8ZSRUKKn-lw1Zy30Vg/exec";
const IMG_QSL = "qsl.jpg"; // fondo de la QSL
let canvasesGenerados = [];

// ğŸ§© Generar QSL (con descarga individual)
function generarQSL(activador, contacto) {
  return new Promise((resolve) => {
    const card = document.createElement('div');
    card.className = 'qslCard';

    const canvas = document.createElement('canvas');
    canvas.width = 600;
    canvas.height = 380;
    const ctx = canvas.getContext('2d');

    const img = new Image();
    img.src = IMG_QSL;
    img.onload = () => {
      // Fondo
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      // Activador destacado
      ctx.font = 'bold 70px "Times New Roman", monospace';
      ctx.fillStyle = '#0033cc';
      ctx.textAlign = 'left';
      ctx.fillText(activador, 25, 60);

      // Datos verticales
      ctx.font = 'bold 18px "Arial Black", monospace';
      ctx.fillStyle = '#00B0F0';
      ctx.textAlign = 'left';
      const startX = 38;
      let y = 180;
      const lineHeight = 25;

      const datos = [
        `CALL: ${contacto.call}`,
        `FECHA: ${contacto.date}`,
        `HORA UTC: ${contacto.time}`,
        `BANDA: ${contacto.band}`,
        `MODO: ${contacto.mode}`
      ];

      datos.forEach((linea) => {
        ctx.strokeStyle = 'black';   // contorno
        ctx.lineWidth = 3;
        ctx.strokeText(linea, startX, y);
        ctx.fillText(linea, startX, y);
        y += lineHeight;
      });

      // Agregar canvas + botÃ³n de descarga
      card.appendChild(canvas);
      const btnDesc = document.createElement('button');
      btnDesc.textContent = 'â¬‡ï¸ Descargar esta QSL';
      btnDesc.onclick = () => descargarIndividual(canvas, activador, contacto.call);
      card.appendChild(btnDesc);

      document.getElementById('qslContainer').appendChild(card);
      canvasesGenerados.push({canvas, activador, visitante: contacto.call});
      resolve();
    };
  });
}

// ğŸ§© Ver QSLs del visitante
async function verQSL() {
  const sdVisitante = document.getElementById('sdVisitante').value.trim().toUpperCase();
  if (!sdVisitante) return alert("Ingrese su SD");

  const container = document.getElementById('qslContainer');
  container.innerHTML = "Cargando...";
  canvasesGenerados = [];
  document.getElementById('accionesDescarga').style.display = 'none';

  try {
    const res = await fetch(API_URL);
    const allData = await res.json();

    container.innerHTML = "";
    let encontrados = 0;

    for (const contacto of allData) {
      if (contacto.call === sdVisitante) {
        await generarQSL(contacto.owner, contacto);
        encontrados++;
      }
    }

    if (encontrados === 0) {
      container.textContent = "No se encontraron QSLs para este SD.";
    } else {
      document.getElementById('accionesDescarga').style.display = 'flex';
    }

  } catch (err) {
    console.error(err);
    container.textContent = "âŒ Error al cargar datos del evento.";
  }
}

// ğŸ“¦ Descargar todas las QSLs como ZIP
async function descargarTodas() {
  if (!canvasesGenerados.length) return;
  const zip = new JSZip();
  canvasesGenerados.forEach((c) => {
    const dataUrl = c.canvas.toDataURL('image/png');
    const base64 = dataUrl.split(',')[1];
    zip.file(`${c.activador}_${c.visitante}.png`, base64, {base64:true});
  });
  const content = await zip.generateAsync({type:"blob"});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(content);
  link.download = 'mis_qsls.zip';
  link.click();
}

// ğŸ–¼ï¸ Descargar imagen actual (primera QSL)
function descargarActual(formato = 'jpg') {
  if (!canvasesGenerados.length) return alert('No hay QSL generada.');
  const canvas = canvasesGenerados[0].canvas;
  const tipo = formato === 'png' ? 'image/png' : 'image/jpeg';
  const link = document.createElement('a');
  link.download = `mi_qsl.${formato}`;
  link.href = canvas.toDataURL(tipo, 0.92);
  link.click();
}

// ğŸ–¼ï¸ Descargar una QSL especÃ­fica
function descargarIndividual(canvas, activador, visitante) {
  const link = document.createElement('a');
  link.download = `${activador}_${visitante}.jpg`;
  link.href = canvas.toDataURL('image/jpeg', 0.92);
  link.click();
}

// ğŸ“‹ Copiar imagen actual al portapapeles
async function copiarActual() {
  if (!canvasesGenerados.length) return alert('No hay QSL generada.');
  const canvas = canvasesGenerados[0].canvas;
  const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
  await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
  alert('ğŸ“‹ Imagen copiada al portapapeles');
}
</script>

</body>
</html>







